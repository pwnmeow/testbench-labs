# -*- mode: ruby -*-
# vi: set ft=ruby :

# Akatsuki Lab - Active Directory Environment (CLEAN SETUP)
# Domain: akatsuki.local
# DC01: Domain Controller (Windows Server 2022)
# WS01: Workstation 1 (Windows 11) - pain is local admin
# WS02: Workstation 2 (Windows 11) - CLEAN (no pre-configured vulnerabilities)
#
# Philosophy: Configure attack conditions only when testing specific attacks
# See docs/AD-ATTACKS.md for setup instructions for each attack type

# ============================================
# Network Configuration
# ============================================
# Isolated private network for the AD lab
# This keeps lab traffic separate from your host network
NETWORK_NAME = "akatsuki_lab"
NETWORK_SUBNET = "192.168.56.0/24"
NETWORK_GATEWAY = "192.168.56.1"
NETWORK_NETMASK = "255.255.255.0"

# Machine IPs
DOMAIN = "akatsuki.local"
NETBIOS = "AKATSUKI"
DC_IP = "192.168.56.10"
WS01_IP = "192.168.56.11"
WS02_IP = "192.168.56.12"

# Optional: Attacker machine IP (if you add a Kali box later)
# KALI_IP = "192.168.56.100"

Vagrant.configure("2") do |config|
  # Common settings for all VMs
  config.vm.communicator = "winrm"
  config.vm.guest = :windows
  config.winrm.username = "vagrant"
  config.winrm.password = "vagrant"
  config.winrm.timeout = 1800
  config.winrm.retry_limit = 30

  # VMware Desktop Provider Settings (default)
  config.vm.provider "vmware_desktop" do |v|
    v.gui = true
    v.vmx["memsize"] = "8192"
    v.vmx["numvcpus"] = "2"
    v.vmx["ethernet0.virtualDev"] = "e1000e"
    # Use vmnet8 (NAT) for first adapter, custom for second
    # This allows VMs to reach internet while staying isolated
  end

  # VirtualBox Provider Settings (alternative)
  config.vm.provider "virtualbox" do |vb|
    vb.gui = true
    vb.memory = "8192"
    vb.cpus = 2
    # Create internal network for isolation
    vb.customize ["modifyvm", :id, "--nictype1", "82545EM"]
  end

  # ============================================
  # DC01 - Domain Controller
  # ============================================
  config.vm.define "dc01", primary: true do |dc|
    dc.vm.box = "akatsuki-lab/windows-server-2022"
    dc.vm.box_url = "file://#{File.dirname(__FILE__)}/../boxes/windows-server-2022.box"
    dc.vm.hostname = "DC01"

    # Network Configuration - Isolated private network
    dc.vm.network "private_network",
      ip: DC_IP,
      netmask: NETWORK_NETMASK,
      virtualbox__intnet: NETWORK_NAME  # VirtualBox: internal network
      # VMware uses hostonly by default for private_network

    # Port Forwarding (for management from host)
    dc.vm.network :forwarded_port, guest: 3389, host: 33890, id: "rdp", auto_correct: true
    dc.vm.network :forwarded_port, guest: 5985, host: 59850, id: "winrm", auto_correct: true

    # Provider-specific memory (DC needs more RAM)
    dc.vm.provider "vmware_desktop" do |v|
      v.vmx["memsize"] = "4096"
      v.vmx["displayName"] = "Akatsuki-DC01"
    end

    dc.vm.provider "virtualbox" do |vb|
      vb.memory = "4096"
      vb.name = "Akatsuki-DC01"
    end

    # Provisioning - Setup Active Directory
    dc.vm.provision "shell", path: "../scripts/provision/setup-dc.ps1", args: [DOMAIN, NETBIOS, DC_IP]

    # Give AD time to stabilize after reboot
    dc.vm.provision "shell", inline: "Write-Host 'Domain Controller setup complete!'"
  end

  # ============================================
  # WS01 - Windows 11 Workstation (pain = local admin)
  # ============================================
  config.vm.define "ws01", autostart: false do |ws|
    ws.vm.box = "akatsuki-lab/windows-11"
    ws.vm.box_url = "file://#{File.dirname(__FILE__)}/../boxes/windows-11.box"
    ws.vm.hostname = "WS01"

    # Network Configuration - Same isolated network as DC
    ws.vm.network "private_network",
      ip: WS01_IP,
      netmask: NETWORK_NETMASK,
      virtualbox__intnet: NETWORK_NAME

    # Port Forwarding
    ws.vm.network :forwarded_port, guest: 3389, host: 33891, id: "rdp", auto_correct: true
    ws.vm.network :forwarded_port, guest: 5985, host: 59851, id: "winrm", auto_correct: true

    # Provider-specific settings
    ws.vm.provider "vmware_desktop" do |v|
      v.vmx["memsize"] = "4096"
      v.vmx["displayName"] = "Akatsuki-WS01"
    end

    ws.vm.provider "virtualbox" do |vb|
      vb.memory = "4096"
      vb.name = "Akatsuki-WS01"
    end

    # Provisioning - Join Domain (pain becomes local admin)
    ws.vm.provision "shell", path: "../scripts/provision/join-domain-ws01.ps1", args: [DOMAIN, DC_IP]

    ws.vm.provision "shell", inline: "Write-Host 'WS01 setup complete! pain is local admin.'"
  end

  # ============================================
  # WS02 - Windows 11 Workstation (CLEAN)
  # No pre-configured vulnerabilities - set up attacks as needed
  # See docs/AD-ATTACKS.md for attack setup instructions
  # ============================================
  config.vm.define "ws02", autostart: false do |ws|
    ws.vm.box = "akatsuki-lab/windows-11"
    ws.vm.box_url = "file://#{File.dirname(__FILE__)}/../boxes/windows-11.box"
    ws.vm.hostname = "WS02"

    # Network Configuration - Same isolated network as DC
    ws.vm.network "private_network",
      ip: WS02_IP,
      netmask: NETWORK_NETMASK,
      virtualbox__intnet: NETWORK_NAME

    # Port Forwarding
    ws.vm.network :forwarded_port, guest: 3389, host: 33892, id: "rdp", auto_correct: true
    ws.vm.network :forwarded_port, guest: 5985, host: 59852, id: "winrm", auto_correct: true

    # Provider-specific settings
    ws.vm.provider "vmware_desktop" do |v|
      v.vmx["memsize"] = "4096"
      v.vmx["displayName"] = "Akatsuki-WS02"
    end

    ws.vm.provider "virtualbox" do |vb|
      vb.memory = "4096"
      vb.name = "Akatsuki-WS02"
    end

    # Provisioning - Join Domain (CLEAN - no pre-configured attacks)
    ws.vm.provision "shell", path: "../scripts/provision/join-domain-ws02.ps1", args: [DOMAIN, DC_IP]

    ws.vm.provision "shell", inline: "Write-Host 'WS02 setup complete! Clean state - configure attacks via AD-ATTACKS.md'"
  end

  # ============================================
  # KALI - Attacker Machine (Optional)
  # Uncomment to add a Kali Linux attack box
  # ============================================
  # config.vm.define "kali", autostart: false do |kali|
  #   kali.vm.box = "kalilinux/rolling"
  #   kali.vm.hostname = "kali"
  #   kali.vm.communicator = "ssh"
  #   kali.vm.guest = :linux
  #
  #   # Same isolated network
  #   kali.vm.network "private_network",
  #     ip: "192.168.56.100",
  #     netmask: NETWORK_NETMASK,
  #     virtualbox__intnet: NETWORK_NAME
  #
  #   kali.vm.provider "vmware_desktop" do |v|
  #     v.vmx["memsize"] = "4096"
  #     v.vmx["displayName"] = "Akatsuki-Kali"
  #   end
  #
  #   kali.vm.provider "virtualbox" do |vb|
  #     vb.memory = "4096"
  #     vb.name = "Akatsuki-Kali"
  #   end
  # end
end
